<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Key</title>
    <link rel="stylesheet" href="getkey.css"> <!-- Link to the getkey CSS -->
</head>
<body class="checkpoint-page">
    <header class="header">
        <h1>Sylph X</h1> <!-- Normal case for Sylph X -->
        <img src="https://i.imgur.com/lPUSD0y.png" alt="Sylph X Logo" class="logo"> <!-- Logo below the label -->
    </header>
    
    <main>
        <div class="checkpoint-panel">
            <h2>Get Key</h2>
            <p id="status-label">Complete the task on Linkvertise to retrieve your key and proceed.</p>
            <a href="https://example.com" class="btn">Get Key</a> <!-- Redirect button -->
        </div>
    </main>

    <script>
        // Function to check if the user came from Linkvertise
        function checkReferrer() {
            const referrer = document.referrer.toLowerCase();
            return referrer.includes('linkvertise.com');
        }

        // Function to check if Checkpoint 2 was completed
        function checkProgress() {
            const progress = JSON.parse(localStorage.getItem('progress')) || [];
            return progress.includes(2); // Check if Checkpoint 2 is marked as completed
        }

        // Function to generate a random key
        function generateKey() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = 'sylphx1day-';
            for (let i = 0; i < 25; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
                if (i % 5 === 4 && i !== 24) {
                    result += '-'; // Add dash after every 5 characters
                }
            }
            return result;
        }

        // Function to save the generated key to GitHub
        async function saveKeyToGitHub(key) {
            const token = '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'; // Your GitHub token
            const repo = 'my-site'; // Your repository name
            const filePath = 'literal-keys.json'; // Path to the JSON file
            const apiUrl = `https://api.github.com/repos/USERNAME/${repo}/contents/${filePath}`;
            
            // Fetch current content of the file
            const response = await fetch(apiUrl, {
                headers: {
                    Authorization: `token ${token}`
                }
            });
            const data = await response.json();
            const sha = data.sha;

            // Get the current keys from the file and add the new key
            const currentKeys = JSON.parse(atob(data.content)).keys || [];
            currentKeys.push(key);

            // Encode the updated keys
            const updatedContent = btoa(JSON.stringify({ keys: currentKeys }));

            // Update the file on GitHub
            await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Add new key',
                    content: updatedContent,
                    sha: sha
                })
            });
        }

        // Function to handle key generation and saving
        function handleKeyGeneration() {
            if (checkReferrer() && checkProgress()) {
                const key = generateKey();
                document.getElementById('status-label').innerText = `Your generated key: ${key}`;

                // Save the key to GitHub
                saveKeyToGitHub(key);

                // Store in localStorage to prevent re-generation
                localStorage.setItem('generatedKey', key);
            } else {
                alert('You must complete the task on Linkvertise to retrieve your key.');
            }
        }

        // Add event listener to the Get Key button
        const getKeyButton = document.querySelector('.btn');
        getKeyButton.addEventListener('click', function(event) {
            if (localStorage.getItem('generatedKey')) {
                alert('You have already generated a key.');
                return;
            }
            handleKeyGeneration();
        });
    </script>
</body>
</html>
