<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Key | Sylph X</title>
    <link rel="stylesheet" href="getkey.css"> <!-- Link to the getkey CSS -->
</head>
<body class="checkpoint-page">
    <header class="header">
        <h1>Sylph X</h1>
        <img src="https://i.imgur.com/lPUSD0y.png" alt="Sylph X Logo" class="logo">
    </header>
    
    <main>
        <div class="checkpoint-panel">
            <h2>Get Key</h2>
            <p id="status-label">Complete the task on Linkvertise to retrieve your key and proceed.</p>
            <button class="btn" id="generateKeyBtn">Generate Key</button>
        </div>
    </main>

    <script>
        /**
         * Checks if the user came from Linkvertise.
         * @returns {boolean} True if the referrer is Linkvertise, otherwise false.
         */
        function checkReferrer() {
            const referrer = document.referrer.toLowerCase();
            return referrer.includes('linkvertise.com');
        }

        /**
         * Generates a random key with a specified pattern.
         * @returns {string} The generated key.
         */
        function generateKey() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = 'sylphx1day-';
            for (let i = 0; i < 25; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
                if (i % 5 === 4 && i !== 24) {
                    result += '-'; // Add a dash after every 5 characters
                }
            }
            return result;
        }

        /**
         * Saves the generated key to GitHub by updating the JSON file.
         * @param {string} key The key to save.
         */
        async function saveKeyToGitHub(key) {
            const token = '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'; // Your GitHub token
            const repo = 'my-site'; // Your repository name
            const filePath = 'literal-keys.json'; // Path to the JSON file
            const apiUrl = `https://api.github.com/repos/FastyGame31/${repo}/contents/${filePath}`;
            
            try {
                // Fetch current file content from GitHub
                const response = await fetch(apiUrl, {
                    headers: {
                        Authorization: `token ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch file content: ${response.statusText}`);
                }

                const data = await response.json();
                const sha = data.sha; // Current file SHA
                const currentContent = JSON.parse(atob(data.content));
                const currentKeys = currentContent.keys || [];

                // Add the new key to the keys array
                currentKeys.push(key);

                // Encode the updated content
                const updatedContent = btoa(JSON.stringify({ keys: currentKeys }));

                // Send the update request to GitHub
                const updateResponse = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Add new key',
                        content: updatedContent,
                        sha: sha
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error(`Failed to update file: ${updateResponse.statusText}`);
                }

                console.log('Key successfully saved to GitHub!');
            } catch (error) {
                console.error('Error saving key to GitHub:', error);
                alert('An error occurred while saving the key. Please try again later.');
            }
        }

        /**
         * Handles the key generation and saving process.
         */
        async function handleKeyGeneration() {
            if (checkReferrer()) {
                const key = generateKey();
                document.getElementById('status-label').innerText = `Your generated key: ${key}`;

                // Save the key to GitHub
                await saveKeyToGitHub(key);

                // Store the key in sessionStorage to restrict one key per session
                sessionStorage.setItem('generatedKey', key);

                // Copy the key to the clipboard
                navigator.clipboard.writeText(key).then(() => {
                    alert('Key copied to clipboard!');
                });
            } else {
                alert('You must complete the task on Linkvertise to retrieve your key.');
            }
        }

        // Add an event listener to the Generate Key button
        document.getElementById('generateKeyBtn').addEventListener('click', () => {
            if (sessionStorage.getItem('generatedKey')) {
                alert('You have already generated a key in this session.');
            } else {
                handleKeyGeneration();
            }
        });
    </script>
</body>
</html>
